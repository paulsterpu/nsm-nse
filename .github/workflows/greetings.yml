name: Greetings

on: [pull_request, issues, push]

jobs:
  greeting:
    runs-on: ubuntu-latest
    container: ciscoappnetworking/kubectl_kind:latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: '0'
          ref: 'master'
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.NSE_HELM_REPO_KEY }}
          name: id_rsa # optional
          known_hosts: ${{ secrets.NSE_HELM_REPO_HOST }}
      - run: |
          cd deployments
          mkdir -p helm_repo/docs/ucnf-kiknos

          cd helm_repo
          git init
          git remote add origin https://github.com/paulsterpu/nse-helm-repo
          git config user.email "paulsterpu@gmail.com"
          git config user.name "paulsterpu"
          git pull origin master

          cd ..
          helm package --destination helm_repo/docs helm/mysql-master
          helm package --destination helm_repo/docs helm/mysql-slave
          helm package --destination helm_repo/docs helm/nsm-addons
          helm package --destination helm_repo/docs/ucnf-kiknos helm/ucnf-kiknos/*
          helm package --destination helm_repo/docs helm/vl3
          helm package --destination helm_repo/docs helm/vl3_hello

          cd helm_repo
          helm repo index docs --url https://paulsterpu.github.io/nse-helm-repo/

          git add .
          git commit --allow-empty -am "Automatic commit from CircleCI"
          git push origin master


